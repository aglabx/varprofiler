# VarProfiler

A high-performance tool for analyzing k-mer variability across genomes, designed to identify regions of unique sequence complexity. VarProfiler helps researchers understand genomic variation patterns by computing unique k-mer counts in sliding windows across chromosomes.

## Features

- **Fast k-mer counting**: Efficient 2-bit encoding for k-mers up to 31bp
- **Parallel processing**: Multi-threaded chromosome processing with configurable thread count
- **Sliding window analysis**: Configurable window size and step for fine-grained analysis
- **Canonical k-mers**: Automatically handles reverse complements
- **Satellite DNA detection**: Automatic identification of low k-mer variability regions
- **Centromere prediction**: Find potential functional centromeres within satellite arrays
- **Sequence extraction**: Export detected regions as FASTA sequences for further analysis
- **Visualization**: Generate publication-quality plots for each chromosome
- **Memory efficient**: Optimized for large genome analysis
- **Thread control**: Specify number of threads or auto-detect based on CPU cores
- **GFF integration**: Overlay satellite DNA annotations from Tandem Repeat Finder or other sources

## Installation

### Prerequisites

- C++ compiler with C++17 support (g++ or clang++)
- Python 3.7+
- Required Python packages: pandas, matplotlib

### Building from source

```bash
# Clone the repository
git clone https://github.com/yourusername/varprofiler.git
cd varprofiler

# Compile the C++ k-mer profiler
make

# Install Python dependencies
pip install -r requirements.txt

# Or install as a package
pip install .
```

## Usage

### Step 1: Generate k-mer profile

```bash
./kmer_profiler <input.fasta> <output.bed> <kmer_len> <window_size> <step_size> [threads]
```

**Parameters:**
- `input.fasta`: Input genome file in FASTA format
- `output.bed`: Output BED file with k-mer counts
- `kmer_len`: Length of k-mers (1-31, recommended: 23)
- `window_size`: Size of sliding window in bp (e.g., 100000)
- `step_size`: Step size for sliding window in bp (e.g., 25000)
- `threads`: (Optional) Number of threads to use (default: number of CPU cores)

**Examples:**
```bash
# Using default number of threads (auto-detect CPU cores)
./kmer_profiler genome.fa kmer_counts.bed 23 100000 25000

# Using specific number of threads (e.g., 8 threads)
./kmer_profiler genome.fa kmer_counts.bed 23 100000 25000 8
```

### Step 2: Detect satellite DNA regions (optional)

```bash
python detect_satellites.py <input.bed> -k <kmer_size> [-o output_prefix] [-g genome.fa]
```

**Parameters:**
- `input.bed`: BED file generated by kmer_profiler
- `-k, --kmer-size`: **Required** - K-mer size used in analysis
- `-o, --output-prefix`: Prefix for output files (default: satellites)
- `-p, --percentile`: Percentile threshold for low variability (default: 5)
- `-m, --min-length`: Minimum region length in bp (default: 10000)
- `-g, --genome`: Genome FASTA file for sequence extraction
- `--global-threshold`: Use global threshold instead of per-chromosome
- `--find-centromeres`: Attempt to identify centromere candidates

**Output files:**
- `.gff3`: GFF3 annotations for all detected regions
- `.fasta`: FASTA sequences of detected regions (if genome provided)
- `_summary.txt`: Summary statistics

**Example:**
```bash
# Basic satellite detection
python detect_satellites.py kmer_counts.bed -k 23 -o human_satellites

# With sequence extraction and centromere detection
python detect_satellites.py kmer_counts.bed -k 23 -o human_satellites -g genome.fa --find-centromeres
```

### Step 3: Visualize results

```bash
python plot_chromosomes.py <input.bed> -k <kmer_size> [-o output_dir] [-g gff_file]
```

**Parameters:**
- `input.bed`: BED file generated by kmer_profiler
- `-k, --kmer-size`: **Required** - K-mer size used in analysis (must match kmer_profiler)
- `-o, --output_dir`: Directory to save plots (default: kmer_plots)
- `-g, --gff`: Optional GFF file with satellite DNA annotations

**Examples:**
```bash
# Basic visualization (k=23 was used in kmer_profiler)
python plot_chromosomes.py kmer_counts.bed -k 23 -o chromosome_plots

# With satellite DNA annotations overlay (k=31 was used)
python plot_chromosomes.py kmer_counts.bed -k 31 -o chromosome_plots -g satellites.gff

# For diploid genomes with maternal/paternal chromosomes
# Input BED file should contain chromosomes named like: chr1_mat, chr1_pat, chr2_maternal, chr2_paternal, etc.
python plot_chromosomes.py diploid_kmers.bed -k 23 -o diploid_plots
```

## Output Format

### BED file format
The tool outputs a standard BED file with the following columns:
1. Chromosome name
2. Window start position (0-based)
3. Window end position
4. Count of unique k-mers in the window

### Visualization
- Generates one PNG file per chromosome
- Additional karyotype-wide plot showing all chromosomes together
- High-resolution plots (200 DPI) suitable for publication
- X-axis: Genomic position in megabases (Mb)
- Y-axis: Percentage of unique k-mers in window (0-110%)
- Fixed Y-axis scale for easy comparison across chromosomes
- Orange shading: Satellite DNA regions from GFF annotations (when provided)
- Cyan line/area: K-mer variability profile
- Title includes k-mer size for clarity

#### Karyotype Plots

**Standard Karyotype Plot**
- Single image with all chromosomes arranged in grid (3 pairs per row for diploid genomes)
- Consistent scale: 1 Mb has same width across all chromosomes
- Natural chromosome sorting (1, 2, ..., 10, ..., 22, X, Y, Z, W, MT)
- **Diploid genome support**: 
  - For diploid assemblies, use `_mat` or `_maternal` suffix for maternal chromosomes and `_pat` or `_paternal` suffix for paternal chromosomes
  - Autosomal chromosomes will be displayed side by side as pairs
  - Sex chromosomes (X, Y, Z, W) are always displayed individually, even if they have mat/pat suffixes
- Saved as `karyotype_kmer_distribution.png`

**Grouped Karyotype Plots** 
- Chromosomes grouped by size for better visibility of smaller chromosomes
- Each size group saved as separate file with its own scale
- Chromosomes fill at least 60% of plot width in each group
- Automatic grouping based on genome size:
  - Large genomes: >150 Mb, 100-150 Mb, 50-100 Mb, 10-50 Mb, Dot chromosomes (<10 Mb)
  - Medium genomes: >100 Mb, 50-100 Mb, 25-50 Mb, 10-25 Mb, Dot chromosomes (<10 Mb)  
  - Small genomes: >50 Mb, 25-50 Mb, 10-25 Mb, 5-10 Mb, Dot chromosomes (<5 Mb)
- Dot chromosomes displayed with up to 8 per row for better space utilization
- Chromosome sizes shown in titles for easy reference
- Saved as separate files: `grouped_Large_gt150_Mb_kmer_distribution.png`, `grouped_Dot_chromosomes_lt10_Mb_kmer_distribution.png`, etc.

## Algorithm

VarProfiler uses an efficient sliding window approach:

1. **K-mer encoding**: Nucleotides are encoded in 2-bit format (A=00, C=01, G=10, T=11)
2. **Canonical k-mers**: For each k-mer, the lexicographically smaller of the forward and reverse complement is used
3. **Sliding window**: 
   - Initial window: Count all unique k-mers
   - Subsequent windows: Add new k-mers entering the window, remove k-mers leaving
4. **Parallel processing**: Each chromosome is processed in a separate thread

## Performance Considerations

- **Memory usage**: Approximately 1GB per 100Mb of sequence data
- **Speed**: Processes human genome (~3Gb) in approximately 30-60 minutes on a modern multi-core system
- **Optimization tips**:
  - Use larger step sizes for faster processing
  - Adjust window size based on desired resolution
  - K-mer length of 23 provides good balance of specificity and speed

## Applications

- **Genome assembly validation**: Identify regions of low complexity or repetitive sequences
- **Comparative genomics**: Compare k-mer profiles between species or individuals
- **Variant detection**: Identify regions with high sequence variability
- **Primer design**: Find regions with unique k-mers for specific amplification
- **Genome annotation**: Correlate k-mer complexity with functional elements

## Citation

If you use VarProfiler in your research, please cite:
```
Marina Popova, Aleksey Komissarov (2025)
VarProfiler: A tool for k-mer variability profiling across genomes
bioRxiv (manuscript in preparation)
```

## Authors

- Marina Popova
- Aleksey Komissarov
- Claude (AI assistant) - Co-author for code implementation and documentation

## License

MIT License - See LICENSE file for details

## Contributing

Contributions are welcome! Please feel free to submit pull requests or open issues for bugs and feature requests.

## Contact

For questions and support:
- Email: Aleksey Komissarov <ad3002@gmail.com>
- GitHub Issues: https://github.com/aglabx/varprofiler/issues